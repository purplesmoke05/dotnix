#!/usr/bin/env bash
set -euo pipefail

if [ $# -eq 0 ]; then
  echo "Usage: $0 <path-to-sops-file>"
  echo "Example: $0 secrets/hq/llm-proxy.env"
  exit 1
fi

REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
TARGET="$1"

# Resolve relative path from repo root
if [[ ! "$TARGET" = /* ]]; then
  TARGET="$REPO_ROOT/$TARGET"
fi

export SOPS_AGE_KEY=$(sudo cat /etc/ssh/ssh_host_ed25519_key | nix-shell -p ssh-to-age --run "ssh-to-age -private-key" 2>/dev/null)

cd "$REPO_ROOT/secrets"
exec nix-shell -p sops age --run "sops \"$TARGET\""
